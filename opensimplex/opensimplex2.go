package opensimplex

import (
	"math"
)

// Based on KdotJPG's Java implementation of OpenSimplex2:
// https://github.com/KdotJPG/OpenSimplex2

const (
	PRIME_X                  int64   = 0x5205402B9270C86F
	PRIME_Y                  int64   = 0x598CD327003817B5
	PRIME_Z                  int64   = 0x5BCC226E9FA0BACB
	PRIME_W                  int64   = 0x56CC5227E58F554B
	HASH_MULTIPLIER          int64   = 0x53A3F72DEEC546F5
	SEED_FLIP_3D             int64   = -0x52D547B2E96ED629
	SEED_OFFSET_4D           int64   = 0xE83DC3E0DA7164D
	ROOT2OVER2               float64 = 0.7071067811865476
	SKEW_2D                  float64 = 0.366025403784439
	UNSKEW_2D                float64 = -0.21132486540518713
	ROOT3OVER3               float64 = 0.5773502691896257
	FALLBACK_ROTATE_3D               = 2.0 / 3.0
	ROTATE_3D_ORTHOGONALIZER         = UNSKEW_2D
	SKEW_4D                  float64 = -0.138196601125011
	UNSKEW_4D                float64 = 0.309016994374947
	LATTICE_STEP_4D          float64 = 0.2
	N_GRADS_2D_EXPONENT      int64   = 7
	N_GRADS_3D_EXPONENT      int64   = 8
	N_GRADS_4D_EXPONENT      int64   = 9
	N_GRADS_2D                       = 1 << N_GRADS_2D_EXPONENT
	N_GRADS_3D                       = 1 << N_GRADS_3D_EXPONENT
	N_GRADS_4D                       = 1 << N_GRADS_4D_EXPONENT
	NORMALIZER_2D            float64 = 0.01001634121365712
	NORMALIZER_3D            float64 = 0.07969837668935331
	NORMALIZER_4D            float64 = 0.0220065933241897
	RSQUARED_2D              float64 = 0.5
	RSQUARED_3D              float64 = 0.6
	RSQUARED_4D              float64 = 0.6
)

var GRADIENTS_2D [N_GRADS_2D * 2]float64
var grads2 = []float64{
	0.38268343236509, 0.923879532511287,
	0.923879532511287, 0.38268343236509,
	0.923879532511287, -0.38268343236509,
	0.38268343236509, -0.923879532511287,
	-0.38268343236509, -0.923879532511287,
	-0.923879532511287, -0.38268343236509,
	-0.923879532511287, 0.38268343236509,
	-0.38268343236509, 0.923879532511287,
	0.130526192220052, 0.99144486137381,
	0.608761429008721, 0.793353340291235,
	0.793353340291235, 0.608761429008721,
	0.99144486137381, 0.130526192220051,
	0.99144486137381, -0.130526192220051,
	0.793353340291235, -0.60876142900872,
	0.608761429008721, -0.793353340291235,
	0.130526192220052, -0.99144486137381,
	-0.130526192220052, -0.99144486137381,
	-0.608761429008721, -0.793353340291235,
	-0.793353340291235, -0.608761429008721,
	-0.99144486137381, -0.130526192220052,
	-0.99144486137381, 0.130526192220051,
	-0.793353340291235, 0.608761429008721,
	-0.608761429008721, 0.793353340291235,
	-0.130526192220052, 0.99144486137381,
}

var GRADIENTS_3D [N_GRADS_3D * 4]float64
var grads3 = []float64{
	2.22474487139, 2.22474487139, -1.0, 0.0,
	2.22474487139, 2.22474487139, 1.0, 0.0,
	3.0862664687972017, 1.1721513422464978, 0.0, 0.0,
	1.1721513422464978, 3.0862664687972017, 0.0, 0.0,
	-2.22474487139, 2.22474487139, -1.0, 0.0,
	-2.22474487139, 2.22474487139, 1.0, 0.0,
	-1.1721513422464978, 3.0862664687972017, 0.0, 0.0,
	-3.0862664687972017, 1.1721513422464978, 0.0, 0.0,
	-1.0, -2.22474487139, -2.22474487139, 0.0,
	1.0, -2.22474487139, -2.22474487139, 0.0,
	0.0, -3.0862664687972017, -1.1721513422464978, 0.0,
	0.0, -1.1721513422464978, -3.0862664687972017, 0.0,
	-1.0, -2.22474487139, 2.22474487139, 0.0,
	1.0, -2.22474487139, 2.22474487139, 0.0,
	0.0, -1.1721513422464978, 3.0862664687972017, 0.0,
	0.0, -3.0862664687972017, 1.1721513422464978, 0.0,
	-2.22474487139, -2.22474487139, -1.0, 0.0,
	-2.22474487139, -2.22474487139, 1.0, 0.0,
	-3.0862664687972017, -1.1721513422464978, 0.0, 0.0,
	-1.1721513422464978, -3.0862664687972017, 0.0, 0.0,
	-2.22474487139, -1.0, -2.22474487139, 0.0,
	-2.22474487139, 1.0, -2.22474487139, 0.0,
	-1.1721513422464978, 0.0, -3.0862664687972017, 0.0,
	-3.0862664687972017, 0.0, -1.1721513422464978, 0.0,
	-2.22474487139, -1.0, 2.22474487139, 0.0,
	-2.22474487139, 1.0, 2.22474487139, 0.0,
	-3.0862664687972017, 0.0, 1.1721513422464978, 0.0,
	-1.1721513422464978, 0.0, 3.0862664687972017, 0.0,
	-1.0, 2.22474487139, -2.22474487139, 0.0,
	1.0, 2.22474487139, -2.22474487139, 0.0,
	0.0, 1.1721513422464978, -3.0862664687972017, 0.0,
	0.0, 3.0862664687972017, -1.1721513422464978, 0.0,
	-1.0, 2.22474487139, 2.22474487139, 0.0,
	1.0, 2.22474487139, 2.22474487139, 0.0,
	0.0, 3.0862664687972017, 1.1721513422464978, 0.0,
	0.0, 1.1721513422464978, 3.0862664687972017, 0.0,
	2.22474487139, -2.22474487139, -1.0, 0.0,
	2.22474487139, -2.22474487139, 1.0, 0.0,
	1.1721513422464978, -3.0862664687972017, 0.0, 0.0,
	3.0862664687972017, -1.1721513422464978, 0.0, 0.0,
	2.22474487139, -1.0, -2.22474487139, 0.0,
	2.22474487139, 1.0, -2.22474487139, 0.0,
	3.0862664687972017, 0.0, -1.1721513422464978, 0.0,
	1.1721513422464978, 0.0, -3.0862664687972017, 0.0,
	2.22474487139, -1.0, 2.22474487139, 0.0,
	2.22474487139, 1.0, 2.22474487139, 0.0,
	1.1721513422464978, 0.0, 3.0862664687972017, 0.0,
	3.0862664687972017, 0.0, 1.1721513422464978, 0.0,
}

var GRADIENTS_4D [N_GRADS_4D * 4]float64
var grads4 = []float64{
	-0.6740059517812944, -0.3239847771997537, -0.3239847771997537, 0.5794684678643381,
	-0.7504883828755602, -0.4004672082940195, 0.15296486218853164, 0.5029860367700724,
	-0.7504883828755602, 0.15296486218853164, -0.4004672082940195, 0.5029860367700724,
	-0.8828161875373585, 0.08164729285680945, 0.08164729285680945, 0.4553054119602712,
	-0.4553054119602712, -0.08164729285680945, -0.08164729285680945, 0.8828161875373585,
	-0.5029860367700724, -0.15296486218853164, 0.4004672082940195, 0.7504883828755602,
	-0.5029860367700724, 0.4004672082940195, -0.15296486218853164, 0.7504883828755602,
	-0.5794684678643381, 0.3239847771997537, 0.3239847771997537, 0.6740059517812944,
	-0.6740059517812944, -0.3239847771997537, 0.5794684678643381, -0.3239847771997537,
	-0.7504883828755602, -0.4004672082940195, 0.5029860367700724, 0.15296486218853164,
	-0.7504883828755602, 0.15296486218853164, 0.5029860367700724, -0.4004672082940195,
	-0.8828161875373585, 0.08164729285680945, 0.4553054119602712, 0.08164729285680945,
	-0.4553054119602712, -0.08164729285680945, 0.8828161875373585, -0.08164729285680945,
	-0.5029860367700724, -0.15296486218853164, 0.7504883828755602, 0.4004672082940195,
	-0.5029860367700724, 0.4004672082940195, 0.7504883828755602, -0.15296486218853164,
	-0.5794684678643381, 0.3239847771997537, 0.6740059517812944, 0.3239847771997537,
	-0.6740059517812944, 0.5794684678643381, -0.3239847771997537, -0.3239847771997537,
	-0.7504883828755602, 0.5029860367700724, -0.4004672082940195, 0.15296486218853164,
	-0.7504883828755602, 0.5029860367700724, 0.15296486218853164, -0.4004672082940195,
	-0.8828161875373585, 0.4553054119602712, 0.08164729285680945, 0.08164729285680945,
	-0.4553054119602712, 0.8828161875373585, -0.08164729285680945, -0.08164729285680945,
	-0.5029860367700724, 0.7504883828755602, -0.15296486218853164, 0.4004672082940195,
	-0.5029860367700724, 0.7504883828755602, 0.4004672082940195, -0.15296486218853164,
	-0.5794684678643381, 0.6740059517812944, 0.3239847771997537, 0.3239847771997537,
	0.5794684678643381, -0.6740059517812944, -0.3239847771997537, -0.3239847771997537,
	0.5029860367700724, -0.7504883828755602, -0.4004672082940195, 0.15296486218853164,
	0.5029860367700724, -0.7504883828755602, 0.15296486218853164, -0.4004672082940195,
	0.4553054119602712, -0.8828161875373585, 0.08164729285680945, 0.08164729285680945,
	0.8828161875373585, -0.4553054119602712, -0.08164729285680945, -0.08164729285680945,
	0.7504883828755602, -0.5029860367700724, -0.15296486218853164, 0.4004672082940195,
	0.7504883828755602, -0.5029860367700724, 0.4004672082940195, -0.15296486218853164,
	0.6740059517812944, -0.5794684678643381, 0.3239847771997537, 0.3239847771997537,
	-0.753341017856078, -0.37968289875261624, -0.37968289875261624, -0.37968289875261624,
	-0.7821684431180708, -0.4321472685365301, -0.4321472685365301, 0.12128480194602098,
	-0.7821684431180708, -0.4321472685365301, 0.12128480194602098, -0.4321472685365301,
	-0.7821684431180708, 0.12128480194602098, -0.4321472685365301, -0.4321472685365301,
	-0.8586508742123365, -0.508629699630796, 0.044802370851755174, 0.044802370851755174,
	-0.8586508742123365, 0.044802370851755174, -0.508629699630796, 0.044802370851755174,
	-0.8586508742123365, 0.044802370851755174, 0.044802370851755174, -0.508629699630796,
	-0.9982828964265062, -0.03381941603233842, -0.03381941603233842, -0.03381941603233842,
	-0.37968289875261624, -0.753341017856078, -0.37968289875261624, -0.37968289875261624,
	-0.4321472685365301, -0.7821684431180708, -0.4321472685365301, 0.12128480194602098,
	-0.4321472685365301, -0.7821684431180708, 0.12128480194602098, -0.4321472685365301,
	0.12128480194602098, -0.7821684431180708, -0.4321472685365301, -0.4321472685365301,
	-0.508629699630796, -0.8586508742123365, 0.044802370851755174, 0.044802370851755174,
	0.044802370851755174, -0.8586508742123365, -0.508629699630796, 0.044802370851755174,
	0.044802370851755174, -0.8586508742123365, 0.044802370851755174, -0.508629699630796,
	-0.03381941603233842, -0.9982828964265062, -0.03381941603233842, -0.03381941603233842,
	-0.37968289875261624, -0.37968289875261624, -0.753341017856078, -0.37968289875261624,
	-0.4321472685365301, -0.4321472685365301, -0.7821684431180708, 0.12128480194602098,
	-0.4321472685365301, 0.12128480194602098, -0.7821684431180708, -0.4321472685365301,
	0.12128480194602098, -0.4321472685365301, -0.7821684431180708, -0.4321472685365301,
	-0.508629699630796, 0.044802370851755174, -0.8586508742123365, 0.044802370851755174,
	0.044802370851755174, -0.508629699630796, -0.8586508742123365, 0.044802370851755174,
	0.044802370851755174, 0.044802370851755174, -0.8586508742123365, -0.508629699630796,
	-0.03381941603233842, -0.03381941603233842, -0.9982828964265062, -0.03381941603233842,
	-0.37968289875261624, -0.37968289875261624, -0.37968289875261624, -0.753341017856078,
	-0.4321472685365301, -0.4321472685365301, 0.12128480194602098, -0.7821684431180708,
	-0.4321472685365301, 0.12128480194602098, -0.4321472685365301, -0.7821684431180708,
	0.12128480194602098, -0.4321472685365301, -0.4321472685365301, -0.7821684431180708,
	-0.508629699630796, 0.044802370851755174, 0.044802370851755174, -0.8586508742123365,
	0.044802370851755174, -0.508629699630796, 0.044802370851755174, -0.8586508742123365,
	0.044802370851755174, 0.044802370851755174, -0.508629699630796, -0.8586508742123365,
	-0.03381941603233842, -0.03381941603233842, -0.03381941603233842, -0.9982828964265062,
	-0.3239847771997537, -0.6740059517812944, -0.3239847771997537, 0.5794684678643381,
	-0.4004672082940195, -0.7504883828755602, 0.15296486218853164, 0.5029860367700724,
	0.15296486218853164, -0.7504883828755602, -0.4004672082940195, 0.5029860367700724,
	0.08164729285680945, -0.8828161875373585, 0.08164729285680945, 0.4553054119602712,
	-0.08164729285680945, -0.4553054119602712, -0.08164729285680945, 0.8828161875373585,
	-0.15296486218853164, -0.5029860367700724, 0.4004672082940195, 0.7504883828755602,
	0.4004672082940195, -0.5029860367700724, -0.15296486218853164, 0.7504883828755602,
	0.3239847771997537, -0.5794684678643381, 0.3239847771997537, 0.6740059517812944,
	-0.3239847771997537, -0.3239847771997537, -0.6740059517812944, 0.5794684678643381,
	-0.4004672082940195, 0.15296486218853164, -0.7504883828755602, 0.5029860367700724,
	0.15296486218853164, -0.4004672082940195, -0.7504883828755602, 0.5029860367700724,
	0.08164729285680945, 0.08164729285680945, -0.8828161875373585, 0.4553054119602712,
	-0.08164729285680945, -0.08164729285680945, -0.4553054119602712, 0.8828161875373585,
	-0.15296486218853164, 0.4004672082940195, -0.5029860367700724, 0.7504883828755602,
	0.4004672082940195, -0.15296486218853164, -0.5029860367700724, 0.7504883828755602,
	0.3239847771997537, 0.3239847771997537, -0.5794684678643381, 0.6740059517812944,
	-0.3239847771997537, -0.6740059517812944, 0.5794684678643381, -0.3239847771997537,
	-0.4004672082940195, -0.7504883828755602, 0.5029860367700724, 0.15296486218853164,
	0.15296486218853164, -0.7504883828755602, 0.5029860367700724, -0.4004672082940195,
	0.08164729285680945, -0.8828161875373585, 0.4553054119602712, 0.08164729285680945,
	-0.08164729285680945, -0.4553054119602712, 0.8828161875373585, -0.08164729285680945,
	-0.15296486218853164, -0.5029860367700724, 0.7504883828755602, 0.4004672082940195,
	0.4004672082940195, -0.5029860367700724, 0.7504883828755602, -0.15296486218853164,
	0.3239847771997537, -0.5794684678643381, 0.6740059517812944, 0.3239847771997537,
	-0.3239847771997537, -0.3239847771997537, 0.5794684678643381, -0.6740059517812944,
	-0.4004672082940195, 0.15296486218853164, 0.5029860367700724, -0.7504883828755602,
	0.15296486218853164, -0.4004672082940195, 0.5029860367700724, -0.7504883828755602,
	0.08164729285680945, 0.08164729285680945, 0.4553054119602712, -0.8828161875373585,
	-0.08164729285680945, -0.08164729285680945, 0.8828161875373585, -0.4553054119602712,
	-0.15296486218853164, 0.4004672082940195, 0.7504883828755602, -0.5029860367700724,
	0.4004672082940195, -0.15296486218853164, 0.7504883828755602, -0.5029860367700724,
	0.3239847771997537, 0.3239847771997537, 0.6740059517812944, -0.5794684678643381,
	-0.3239847771997537, 0.5794684678643381, -0.6740059517812944, -0.3239847771997537,
	-0.4004672082940195, 0.5029860367700724, -0.7504883828755602, 0.15296486218853164,
	0.15296486218853164, 0.5029860367700724, -0.7504883828755602, -0.4004672082940195,
	0.08164729285680945, 0.4553054119602712, -0.8828161875373585, 0.08164729285680945,
	-0.08164729285680945, 0.8828161875373585, -0.4553054119602712, -0.08164729285680945,
	-0.15296486218853164, 0.7504883828755602, -0.5029860367700724, 0.4004672082940195,
	0.4004672082940195, 0.7504883828755602, -0.5029860367700724, -0.15296486218853164,
	0.3239847771997537, 0.6740059517812944, -0.5794684678643381, 0.3239847771997537,
	-0.3239847771997537, 0.5794684678643381, -0.3239847771997537, -0.6740059517812944,
	-0.4004672082940195, 0.5029860367700724, 0.15296486218853164, -0.7504883828755602,
	0.15296486218853164, 0.5029860367700724, -0.4004672082940195, -0.7504883828755602,
	0.08164729285680945, 0.4553054119602712, 0.08164729285680945, -0.8828161875373585,
	-0.08164729285680945, 0.8828161875373585, -0.08164729285680945, -0.4553054119602712,
	-0.15296486218853164, 0.7504883828755602, 0.4004672082940195, -0.5029860367700724,
	0.4004672082940195, 0.7504883828755602, -0.15296486218853164, -0.5029860367700724,
	0.3239847771997537, 0.6740059517812944, 0.3239847771997537, -0.5794684678643381,
	0.5794684678643381, -0.3239847771997537, -0.6740059517812944, -0.3239847771997537,
	0.5029860367700724, -0.4004672082940195, -0.7504883828755602, 0.15296486218853164,
	0.5029860367700724, 0.15296486218853164, -0.7504883828755602, -0.4004672082940195,
	0.4553054119602712, 0.08164729285680945, -0.8828161875373585, 0.08164729285680945,
	0.8828161875373585, -0.08164729285680945, -0.4553054119602712, -0.08164729285680945,
	0.7504883828755602, -0.15296486218853164, -0.5029860367700724, 0.4004672082940195,
	0.7504883828755602, 0.4004672082940195, -0.5029860367700724, -0.15296486218853164,
	0.6740059517812944, 0.3239847771997537, -0.5794684678643381, 0.3239847771997537,
	0.5794684678643381, -0.3239847771997537, -0.3239847771997537, -0.6740059517812944,
	0.5029860367700724, -0.4004672082940195, 0.15296486218853164, -0.7504883828755602,
	0.5029860367700724, 0.15296486218853164, -0.4004672082940195, -0.7504883828755602,
	0.4553054119602712, 0.08164729285680945, 0.08164729285680945, -0.8828161875373585,
	0.8828161875373585, -0.08164729285680945, -0.08164729285680945, -0.4553054119602712,
	0.7504883828755602, -0.15296486218853164, 0.4004672082940195, -0.5029860367700724,
	0.7504883828755602, 0.4004672082940195, -0.15296486218853164, -0.5029860367700724,
	0.6740059517812944, 0.3239847771997537, 0.3239847771997537, -0.5794684678643381,
	0.03381941603233842, 0.03381941603233842, 0.03381941603233842, 0.9982828964265062,
	-0.044802370851755174, -0.044802370851755174, 0.508629699630796, 0.8586508742123365,
	-0.044802370851755174, 0.508629699630796, -0.044802370851755174, 0.8586508742123365,
	-0.12128480194602098, 0.4321472685365301, 0.4321472685365301, 0.7821684431180708,
	0.508629699630796, -0.044802370851755174, -0.044802370851755174, 0.8586508742123365,
	0.4321472685365301, -0.12128480194602098, 0.4321472685365301, 0.7821684431180708,
	0.4321472685365301, 0.4321472685365301, -0.12128480194602098, 0.7821684431180708,
	0.37968289875261624, 0.37968289875261624, 0.37968289875261624, 0.753341017856078,
	0.03381941603233842, 0.03381941603233842, 0.9982828964265062, 0.03381941603233842,
	-0.044802370851755174, 0.044802370851755174, 0.8586508742123365, 0.508629699630796,
	-0.044802370851755174, 0.508629699630796, 0.8586508742123365, -0.044802370851755174,
	-0.12128480194602098, 0.4321472685365301, 0.7821684431180708, 0.4321472685365301,
	0.508629699630796, -0.044802370851755174, 0.8586508742123365, -0.044802370851755174,
	0.4321472685365301, -0.12128480194602098, 0.7821684431180708, 0.4321472685365301,
	0.4321472685365301, 0.4321472685365301, 0.7821684431180708, -0.12128480194602098,
	0.37968289875261624, 0.37968289875261624, 0.753341017856078, 0.37968289875261624,
	0.03381941603233842, 0.9982828964265062, 0.03381941603233842, 0.03381941603233842,
	-0.044802370851755174, 0.8586508742123365, -0.044802370851755174, 0.508629699630796,
	-0.044802370851755174, 0.8586508742123365, 0.508629699630796, -0.044802370851755174,
	-0.12128480194602098, 0.7821684431180708, 0.4321472685365301, 0.4321472685365301,
	0.508629699630796, 0.8586508742123365, -0.044802370851755174, -0.044802370851755174,
	0.4321472685365301, 0.7821684431180708, -0.12128480194602098, 0.4321472685365301,
	0.4321472685365301, 0.7821684431180708, 0.4321472685365301, -0.12128480194602098,
	0.37968289875261624, 0.753341017856078, 0.37968289875261624, 0.37968289875261624,
	0.9982828964265062, 0.03381941603233842, 0.03381941603233842, 0.03381941603233842,
	0.8586508742123365, -0.044802370851755174, -0.044802370851755174, 0.508629699630796,
	0.8586508742123365, -0.044802370851755174, 0.508629699630796, -0.044802370851755174,
	0.7821684431180708, -0.12128480194602098, 0.4321472685365301, 0.4321472685365301,
	0.8586508742123365, 0.508629699630796, -0.044802370851755174, -0.044802370851755174,
	0.7821684431180708, 0.4321472685365301, -0.12128480194602098, 0.4321472685365301,
	0.7821684431180708, 0.4321472685365301, 0.4321472685365301, -0.12128480194602098,
	0.753341017856078, 0.37968289875261624, 0.37968289875261624, 0.37968289875261624,
}

type OpenSimplex2 struct {
	seed int64
}

func NewOpenSimplex2(seed int64) OpenSimplex2 {
	for i := 0; i < len(grads2); i++ {
		grads2[i] /= NORMALIZER_2D
	}
	j := 0
	for i := 0; i < len(GRADIENTS_2D); i++ {
		if j == len(grads2) {
			j = 0
		}
		GRADIENTS_2D[i] = grads2[j]
		j++
	}
	for i := 0; i < len(grads3); i++ {
		grads3[i] /= NORMALIZER_3D
	}
	j = 0
	for i := 0; i < len(GRADIENTS_3D); i++ {
		if j == len(grads3) {
			j = 0
		}
		GRADIENTS_3D[i] = grads3[j]
		j++
	}
	for i := 0; i < len(grads4); i++ {
		grads4[i] /= NORMALIZER_4D
	}
	j = 0
	for i := 0; i < len(GRADIENTS_4D); i++ {
		if j == len(grads4) {
			j = 0
		}
		GRADIENTS_4D[i] = grads4[j]
		j++
	}
	return OpenSimplex2{seed: seed}
}

// 2D

// Noise2D generates 2D Simplex noise with standard lattice orientation.
func (o OpenSimplex2) Noise2D(x, y float64) float64 {
	s := SKEW_2D * (x + y)
	xs := x + s
	ys := y + s
	return noise2UnskewedBase(o.seed, xs, ys)
}

// Noise2DImproveX generates 2D Simplex noise with Y pointing down the main diagonal.
func (o OpenSimplex2) Noise2DImproveX(x, y float64) float64 {
	xx := x * ROOT2OVER2
	yy := y * (ROOT2OVER2 * (1 + 2*SKEW_2D))
	return noise2UnskewedBase(o.seed, xx+yy, yy-xx)
}

// noise2UnskewedBase is the base function for 2D Simplex noise
func noise2UnskewedBase(seed int64, x, y float64) float64 {
	// Get base points and offsets.
	xInt, xFrac := math.Modf(x)
	yInt, yFrac := math.Modf(y)

	// Prime pre-multiplication for hash.
	xsbp := int64(xInt) * PRIME_X
	ysbp := int64(yInt) * PRIME_Y

	// Unskew
	t := (xFrac + yFrac) * UNSKEW_2D
	dx0 := xFrac + t
	dy0 := yFrac + t

	// First vertex
	var value float64
	a0 := RSQUARED_2D - dx0*dx0 - dy0*dy0
	if a0 > 0 {
		value = a0 * a0 * a0 * a0 * grad2D(seed, xsbp, ysbp, dx0, dy0)
	}

	// Second vertex
	a1 := (2*(1+2*UNSKEW_2D)*(1/UNSKEW_2D+2))*t + ((-2 * (1 + 2*UNSKEW_2D) * (1 + 2*UNSKEW_2D)) + a0)
	if a1 > 0 {
		dx := dx0 - (1 + 2*UNSKEW_2D)
		dy := dy0 - (1 + 2*UNSKEW_2D)
		value += a1 * a1 * a1 * a1 * grad2D(seed, xsbp+PRIME_X, ysbp+PRIME_Y, dx, dy)
	}

	// Third vertex
	if dy0 > dx0 {
		dx2 := dx0 - UNSKEW_2D
		dy2 := dy0 - UNSKEW_2D + 1
		a2 := RSQUARED_2D - dx2*dx2 - dy2*dy2
		if a2 > 0 {
			value += a2 * a2 * a2 * a2 * grad2D(seed, xsbp, ysbp+PRIME_Y, dx2, dy2)
		}
	} else {
		dx2 := dx0 - UNSKEW_2D + 1
		dy2 := dy0 - UNSKEW_2D
		a2 := RSQUARED_2D - dx2*dx2 - dy2*dy2
		if a2 > 0 {
			value += a2 * a2 * a2 * a2 * grad2D(seed, xsbp+PRIME_X, ysbp, dx2, dy2)
		}
	}
	return value
}

// 3D

// Picked a default, see various implementations below
func (o OpenSimplex2) Noise3D(x, y, z float64) float64 {
	return o.Noise3DImproveXY(x, y, z)
}

/**
 * 3D OpenSimplex2 noise, with better visual isotropy in (X, Y).
 * Recommended for 3D terrain and time-varied animations.
 * The Z coordinate should always be the "different" coordinate in whatever your use case is.
 * If Y is vertical in world coordinates, call noise3_ImproveXZ(x, z, Y) or use noise3_XZBeforeY.
 * If Z is vertical in world coordinates, call noise3_ImproveXZ(x, y, Z).
 * For a time varied animation, call noise3_ImproveXY(x, y, T).
 */
func (o OpenSimplex2) Noise3DImproveXY(x, y, z float64) float64 {
	// Re-orient the cubic lattices without skewing, so Z points up the main lattice diagonal,
	// and the planes formed by XY are moved far out of alignment with the cube faces.
	// Orthonormal rotation. Not a skew transform.
	xy := x + y
	s2 := xy * ROTATE_3D_ORTHOGONALIZER
	zz := z * ROOT3OVER3
	xr := x + s2 + zz
	yr := y + s2 + zz
	zr := xy*-ROOT3OVER3 + zz

	// Evaluate both lattices to form a BCC lattice.
	return noise3UnrotatedBase(o.seed, xr, yr, zr)
}

/**
 * 3D OpenSimplex2 noise, with better visual isotropy in (X, Z).
 * Recommended for 3D terrain and time-varied animations.
 * The Y coordinate should always be the "different" coordinate in whatever your use case is.
 * If Y is vertical in world coordinates, call noise3_ImproveXZ(x, Y, z).
 * If Z is vertical in world coordinates, call noise3_ImproveXZ(x, Z, y) or use noise3_ImproveXY.
 * For a time varied animation, call noise3_ImproveXZ(x, T, y) or use noise3_ImproveXY.
 */
func (o OpenSimplex2) Noise3DImproveXZ(x, y, z float64) float64 {
	// Re-orient the cubic lattices without skewing, so Y points up the main lattice diagonal,
	// and the planes formed by XZ are moved far out of alignment with the cube faces.
	// Orthonormal rotation. Not a skew transform.
	xz := x + z
	s2 := xz * ROTATE_3D_ORTHOGONALIZER
	yy := y * ROOT3OVER3
	xr := x + s2 + yy
	yr := xz*-ROOT3OVER3 + yy
	zr := z + s2 + yy

	// Evaluate both lattices to form a BCC lattice.
	return noise3UnrotatedBase(o.seed, xr, yr, zr)
}

/**
 * 3D OpenSimplex2 noise, fallback rotation option
 * Use noise3_ImproveXY or noise3_ImproveXZ instead, wherever appropriate.
 * They have less diagonal bias. This function's best use is as a fallback.
 */
func (o OpenSimplex2) Noise3DFallback(x, y, z float64) float64 {
	// Re-orient the cubic lattices via rotation, to produce a familiar look.
	// Orthonormal rotation. Not a skew transform.
	r := FALLBACK_ROTATE_3D * (x + y + z)
	xr := r - x
	yr := r - y
	zr := r - z

	// Evaluate both lattices to form a BCC lattice.
	return noise3UnrotatedBase(o.seed, xr, yr, zr)
}

func noise3UnrotatedBase(seed int64, xr float64, yr float64, zr float64) float64 {
	// Get base points and offsets.
	xrb := fastRound(xr)
	yrb := fastRound(yr)
	zrb := fastRound(zr)
	xri := xr - float64(xrb)
	yri := yr - float64(yrb)
	zri := zr - float64(zrb)

	// -1 if positive, 1 if negative
	xNSign := int64(-1-xri) | 1
	yNSign := int64(-1-yri) | 1
	zNSign := int64(-1-zri) | 1

	// Compute absolute values, using the above as a shortcut
	ax0 := float64(xNSign) * -xri
	ay0 := float64(yNSign) * -yri
	az0 := float64(zNSign) * -zri

	// Prime pre-multiplication for hash.
	xrbp := xrb * PRIME_X
	yrbp := yrb * PRIME_Y
	zrbp := zrb * PRIME_Z

	// Loop: Pick an edge on each lattice copy.
	value := 0.0
	a := (RSQUARED_3D - xri*xri) - (yri*yri + zri*zri)
	for l := 0; ; l++ {
		if a > 0 {
			value += a * a * a * a * grad3D(seed, xrbp, yrbp, zrbp, xri, yri, zri)
		}
		if ax0 >= ay0 && ax0 >= az0 {
			b := a + ax0 + ax0
			if b > 1 {
				b--
				value += b * b * b * b * grad3D(seed, xrbp-xNSign*PRIME_X, yrbp, zrbp, xri+float64(xNSign), yri, zri)
			}
		} else if ay0 > ax0 && ay0 >= az0 {
			b := a + ay0 + ay0
			if b > 1 {
				b--
				value += b * b * b * b * grad3D(seed, xrbp, yrbp-yNSign*PRIME_Y, zrbp, xri, yri+float64(yNSign), zri)
			}
		} else {
			b := a + az0 + az0
			if b > 1 {
				b--
				value += b * b * b * b * grad3D(seed, xrbp, yrbp, zrbp-zNSign*PRIME_Z, xri, yri, zri+float64(zNSign))
			}
		}

		// Break from loop if we're done, skipping updates below.
		if l == 1 {
			break
		}

		// Update absolute value.
		ax0 = 0.5 - ax0
		ay0 = 0.5 - ay0
		az0 = 0.5 - az0

		// Update relative coordinate.
		xri = float64(xNSign) * ax0
		yri = float64(yNSign) * ay0
		zri = float64(zNSign) * az0

		// Update falloff
		a += (0.75 - ax0) - (ay0 + az0)

		// Update prime for hash.
		xrbp += (xNSign >> 1) & PRIME_X
		yrbp += (yNSign >> 1) & PRIME_Y
		zrbp += (zNSign >> 1) & PRIME_Z

		// Update the reverse sign indicators.
		xNSign = -xNSign
		yNSign = -yNSign
		zNSign = -zNSign
		// Update the seed for the other lattice copy.
		seed ^= SEED_FLIP_3D
	}

	return 0.0
}

// 4D

// Picked a default, see various implementations below
func (o OpenSimplex2) Noise4D(x, y, z, w float64) float64 {
	return o.Noise4DImproveXYZImproveXZ(x, y, z, w)
}

/**
 * 4D OpenSimplex2 noise, with XYZ oriented like noise3_ImproveXY
 * and W for an extra degree of freedom. W repeats eventually.
 * Recommended for time-varied animations which texture a 3D object (W=time)
 * in a space where Z is vertical
 */
func (o OpenSimplex2) Noise4DImproveXYZImproveXY(x, y, z, w float64) float64 {
	xy := x + y
	s2 := xy * -0.21132486540518699998
	zz := z * 0.28867513459481294226
	ww := w * 0.2236067977499788
	xr := x + s2 + zz + ww
	yr := y + s2 + zz + ww
	zr := xy*-0.57735026918962599998 + zz + ww
	wr := z*-0.866025403784439 + ww

	return noise4UnskewedBase(o.seed, xr, yr, zr, wr)
}

/**
 * 4D OpenSimplex2 noise, with XYZ oriented like noise3_ImproveXZ
 * and W for an extra degree of freedom. W repeats eventually.
 * Recommended for time-varied animations which texture a 3D object (W=time)
 * in a space where Y is vertical
 */
func (o OpenSimplex2) Noise4DImproveXYZImproveXZ(x, y, z, w float64) float64 {
	xz := x + z
	s2 := xz * -0.21132486540518699998
	yy := y * 0.28867513459481294226
	ww := w * 0.2236067977499788
	xr := x + yy + ww + s2
	yr := xz*-0.57735026918962599998 + yy + ww
	zr := z + yy + ww + s2
	wr := y*-0.866025403784439 + ww

	return noise4UnskewedBase(o.seed, xr, yr, zr, wr)
}

/**
 * 4D OpenSimplex2 noise, with XYZ oriented like noise3_Fallback
 * and W for an extra degree of freedom. W repeats eventually.
 * Recommended for time-varied animations which texture a 3D object (W=time)
 * where there isn't a clear distinction between horizontal and vertical
 */
func (o OpenSimplex2) Noise4DImproveXYZ(x, y, z, w float64) float64 {
	xyz := x + y + z
	ww := w * 0.2236067977499788
	s2 := xyz*-0.16666666666666666 + ww
	xs := x + s2
	ys := y + s2
	zs := z + s2
	ws := -0.5*xyz + ww

	return noise4UnskewedBase(o.seed, xs, ys, zs, ws)
}

/**
 * 4D OpenSimplex2 noise, with XY and ZW forming orthogonal triangular-based planes.
 * Recommended for 3D terrain, where X and Y (or Z and W) are horizontal.
 * Recommended for noise(x, y, sin(time), cos(time)) trick.
 */
func (o OpenSimplex2) Noise4DImproveXZImproveZW(x, y, z, w float64) float64 {
	s2 := (x+y)*-0.178275657951399372 + (z+w)*0.215623393288842828
	t2 := (z+w)*-0.403949762580207112 + (x+y)*-0.375199083010075342
	xs := x + s2
	ys := y + s2
	zs := z + t2
	ws := w + t2

	return noise4UnskewedBase(o.seed, xs, ys, zs, ws)
}

// 4D OpenSimplex2 noise, fallback lattice orientation.
func (o OpenSimplex2) Noise4DFallback(x, y, z, w float64) float64 {
	// Get points for A4 lattice
	s := SKEW_4D * (x + y + z + w)
	xs := x + s
	ys := y + s
	zs := z + s
	ws := w + s

	return noise4UnskewedBase(o.seed, xs, ys, zs, ws)
}

func noise4UnskewedBase(seed int64, x, y, z, w float64) float64 {
	// Get base points and offsets.
	xInt, xFrac := math.Modf(x)
	yInt, yFrac := math.Modf(y)
	zInt, zFrac := math.Modf(z)
	wInt, wFrac := math.Modf(w)

	// Determine which lattice we can be confident has a contributing point its corresponding cell's base simplex.
	// We only look at the spaces between the diagonal planes.
	fracSum := xFrac + yFrac + zFrac + wFrac
	startingLattice := int64(fracSum * 1.25)

	// Offset for seed based on first lattice copy.
	seed += startingLattice * SEED_OFFSET_4D

	// Offset for lattice point relative positions (skewed)
	startingLatticeOffset := float64(startingLattice) * -LATTICE_STEP_4D
	xFrac += startingLatticeOffset
	yFrac += startingLatticeOffset
	zFrac += startingLatticeOffset
	wFrac += startingLatticeOffset

	// Prep for vertex contributions.
	ssi := (fracSum + startingLatticeOffset*4) * UNSKEW_4D

	// Prime pre-multiplication for hash.
	xsvp := int64(xInt) * PRIME_X
	ysvp := int64(yInt) * PRIME_Y
	zsvp := int64(zInt) * PRIME_Z
	wsvp := int64(wInt) * PRIME_W

	// Five points to add, total, from five copies of the A4 lattice.
	var value float64
	for i := 0; ; i++ {

		// Next point is the closest vertex on the 4-simplex whose base vertex is the aforementioned vertex.
		score0 := 1.0 + ssi*(-1.0/UNSKEW_4D)
		if xFrac >= yFrac && xFrac >= zFrac && xFrac >= wFrac && xFrac >= score0 {
			xsvp += PRIME_X
			xFrac -= 1.0
			ssi -= UNSKEW_4D
		} else if yFrac >= xFrac && yFrac >= zFrac && yFrac >= wFrac && yFrac >= score0 {
			ysvp += PRIME_Y
			yFrac -= 1.0
			ssi -= UNSKEW_4D
		} else if zFrac >= xFrac && zFrac >= yFrac && zFrac >= wFrac && zFrac >= score0 {
			zsvp += PRIME_Z
			zFrac -= 1.0
			ssi -= UNSKEW_4D
		} else if wFrac >= xFrac && wFrac >= yFrac && wFrac >= zFrac && wFrac >= score0 {
			wsvp += PRIME_W
			wFrac -= 1.0
			ssi -= UNSKEW_4D
		}

		// gradient contribution with falloff.
		dx := xFrac + ssi
		dy := yFrac + ssi
		dz := zFrac + ssi
		dw := wFrac + ssi
		a := dx*dx + dy*dy + dz*dz + dw*dw
		if a < RSQUARED_4D {
			a -= RSQUARED_4D
			a *= a
			value += a * a * grad4D(seed, xsvp, ysvp, zsvp, wsvp, dx, dy, dz, dw)
		}

		// Break from loop if we're done, skipping updates below.
		if i == 4 {
			break
		}

		// Update for next lattice copy shifted down by <-0.2, -0.2, -0.2, -0.2>.
		xFrac += LATTICE_STEP_4D
		yFrac += LATTICE_STEP_4D
		zFrac += LATTICE_STEP_4D
		wFrac += LATTICE_STEP_4D
		ssi += LATTICE_STEP_4D * 4 * UNSKEW_4D
		seed -= SEED_OFFSET_4D

		// Because we don't always start on the same lattice copy, there's a special reset case.
		if int64(i) == startingLattice {
			xsvp -= PRIME_X
			ysvp -= PRIME_Y
			zsvp -= PRIME_Z
			wsvp -= PRIME_W
			seed += SEED_OFFSET_4D * 5
		}
	}
	return value
}

// Utility functions

func fastRound(x float64) int64 {
	if x < 0 {
		return int64(x - 0.5)
	}
	return int64(x + 0.5)
}

func grad2D(seed int64, xsvp int64, ysvp int64, dx0 float64, dy0 float64) float64 {
	hash := seed ^ xsvp ^ ysvp
	hash *= HASH_MULTIPLIER
	hash ^= hash >> (64 - N_GRADS_2D_EXPONENT + 1)
	gi := hash & ((N_GRADS_2D - 1) << 1)
	return GRADIENTS_2D[gi|0]*dx0 + GRADIENTS_2D[gi|1]*dy0
}

func grad3D(seed int64, xsvp int64, ysvp int64, zsvp int64, dx0 float64, dy0 float64, dz0 float64) float64 {
	hash := (seed ^ xsvp) ^ (ysvp ^ zsvp)
	hash *= HASH_MULTIPLIER
	hash ^= hash >> (64 - N_GRADS_3D_EXPONENT + 2)
	gi := hash & ((N_GRADS_3D - 1) << 2)
	return GRADIENTS_3D[gi|0]*dx0 + GRADIENTS_3D[gi|1]*dy0 + GRADIENTS_3D[gi|2]*dz0
}

func grad4D(seed int64, xsvp int64, ysvp int64, zsvp int64, wsvp int64, dx0 float64, dy0 float64, dz0 float64, dw0 float64) float64 {
	hash := seed ^ (xsvp ^ ysvp) ^ (zsvp ^ wsvp)
	hash *= HASH_MULTIPLIER
	hash ^= hash >> (64 - N_GRADS_4D_EXPONENT + 2)
	gi := hash & ((N_GRADS_4D - 1) << 3)
	return GRADIENTS_4D[gi|0]*dx0 + GRADIENTS_4D[gi|1]*dy0 + GRADIENTS_4D[gi|2]*dz0 + GRADIENTS_4D[gi|3]*dw0
}
